<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>STUN message handling in Session Initiation Protocol (SIP) Back-to-Back User Agents (B2BUAs)</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
      /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
      a.info {
          /* This is the key. */
          position: relative;
          z-index: 24;
          text-decoration: none;
      }
      a.info:hover {
          z-index: 25;
          color: #FFF; background-color: #900;
      }
      a.info span { display: none; }
      a.info:hover span.info {
          /* The span will display just on :hover state. */
          display: block;
          position: absolute;
          font-size: smaller;
          top: 2em; left: -5em; width: 15em;
          padding: 2px; border: 1px solid #333;
          color: #900; background-color: #EEE;
          text-align: left;
      }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  max-width: 55em;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology"/>
<link href="#rfc.section.3" rel="Chapter" title="3 Media Plane B2BUAs"/>
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Overview"/>
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 ICE termination with B2BUA"/>
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 STUN/ICE passthrough with B2BUA"/>
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 STUN interaction with DTLS-SRTP in B2BUA"/>
<link href="#rfc.section.3.5" rel="Chapter" title="3.5 STUN Handling in B2BUA with Forked Signaling"/>
<link href="#rfc.section.4" rel="Chapter" title="4 Security Considerations"/>
<link href="#rfc.section.5" rel="Chapter" title="5 IANA Considerations"/>
<link href="#rfc.section.6" rel="Chapter" title="6 Acknowledgments"/>
<link href="#rfc.references" rel="Chapter" title="7 References"/>
<link href="#rfc.references.1" rel="Chapter" title="7.1 Normative References"/>
<link href="#rfc.references.2" rel="Chapter" title="7.2 Informative References"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.4.7 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Ravindranath, R., Reddy, T., and G. Salgueiro" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-ram-straw-b2bua-stun-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2014-7-7" />
  <meta name="dct.abstract" content="SIP Back-to-Back User Agents (B2BUAs) are often envisaged to be on the media path, rather than just intercepting signaling.  This means that B2BUAs often act on the media path leading to separate media legs that the B2BUA correlates and bridges together. When acting on the media path, the B2BUAs are likely to receive packets like STUN that are part of the ICE connectivity checks and keep-alive mechanisms apart from the media packets. It is critical that the B2BUAs handle these STUN messages properly." />
  <meta name="description" content="SIP Back-to-Back User Agents (B2BUAs) are often envisaged to be on the media path, rather than just intercepting signaling.  This means that B2BUAs often act on the media path leading to separate media legs that the B2BUA correlates and bridges together. When acting on the media path, the B2BUAs are likely to receive packets like STUN that are part of the ICE connectivity checks and keep-alive mechanisms apart from the media packets. It is critical that the B2BUAs handle these STUN messages properly." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">STRAW</td>
  <td class="right">R. Ravindranath</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">T. Reddy</td>
</tr>
<tr>
  <td class="left">Intended status: Standards Track</td>
  <td class="right">G. Salgueiro</td>
</tr>
<tr>
  <td class="left">Expires: January 8, 2015</td>
  <td class="right">Cisco</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">July 7, 2014</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">STUN message handling in Session Initiation Protocol (SIP) Back-to-Back User Agents (B2BUAs)<br />
  <span class="filename">draft-ram-straw-b2bua-stun-00</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>SIP Back-to-Back User Agents (B2BUAs) are often envisaged to be on the media path, rather than just intercepting signaling.  This means that B2BUAs often act on the media path leading to separate media legs that the B2BUA correlates and bridges together. When acting on the media path, the B2BUAs are likely to receive packets like STUN that are part of the ICE connectivity checks and keep-alive mechanisms apart from the media packets. It is critical that the B2BUAs handle these STUN messages properly.</p>
<p>This document defines the proper behavior B2BUAs should follow when STUN messages are sent on the media path.</p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on January 8, 2015.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2014 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<li>2.   <a href="#rfc.section.2">Terminology</a></li>
<li>3.   <a href="#rfc.section.3">Media Plane B2BUAs</a></li>
<li>3.1.   <a href="#rfc.section.3.1">Overview</a></li>
<li>3.2.   <a href="#rfc.section.3.2">ICE termination with B2BUA</a></li>
<li>3.3.   <a href="#rfc.section.3.3">STUN/ICE passthrough with B2BUA</a></li>
<li>3.4.   <a href="#rfc.section.3.4">STUN interaction with DTLS-SRTP in B2BUA</a></li>
<li>3.5.   <a href="#rfc.section.3.5">STUN Handling in B2BUA with Forked Signaling</a></li>
<li>4.   <a href="#rfc.section.4">Security Considerations</a></li>
<li>5.   <a href="#rfc.section.5">IANA Considerations</a></li>
<li>6.   <a href="#rfc.section.6">Acknowledgments</a></li>
<li>7.   <a href="#rfc.references">References</a></li>
<li>7.1.   <a href="#rfc.references.1">Normative References</a></li>
<li>7.2.   <a href="#rfc.references.2">Informative References</a></li>
<li><a href="#rfc.authors">Authors' Addresses</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">Protocols using offer/answer like the Session Initiation Protocol (SIP) <a href="#RFC3261">[RFC3261]</a> are difficult to operate through Network Address Translators (NAT) because they carry IP addresses within their messages.  To remedy this, an extension to SDP <a href="#RFC4566">[RFC4566]</a>, called Interactive Connectivity Establishment (ICE) has been defined <a href="#RFC5245">[RFC5245]</a>.  ICE defines procedures by which agents gather a multiplicity of addresses, include all of them in an SDP offer or answer, and then use peer-to-peer connectivity checks using Session Traversal Utilities for NAT (STUN) <a href="#RFC5389">[RFC5389]</a>  to determine a valid candidate pair for each media stream.</p>
<p id="rfc.section.1.p.2">In many SIP deployments, SIP entities exist in the SIP signaling path between the originating and final terminating endpoints. These SIP entities, as described in <a href="#RFC7092">[RFC7092]</a>, modify SIP headers, SDP bodies and also are likely to be on the media path. Such entities, when present in the media path, are likely to do several things. For example, some B2BUAs modify parts of the SDP body (like IP address, port) and subsequently modify the transport headers as well.  There are other types of B2BUAs that completely modify the transport payload.  (e.g., a media transcoder).</p>
<p id="rfc.section.1.p.3">Section 18.6 of ICE <a href="#RFC5245">[RFC5245]</a> explains about two different behaviors when B2BUAs are present.  Some B2BUAs are likely to remove all the SDP ICE attributes before sending the SDP across to the other side.  Consequently, the call will appear to both endpoints as if the other side doesn't support ICE.  There are other types of B2BUAs that passes the ICE attributes without modification, yet modifies the default destination for media (contained in the m= and c= lines and rtcp attribute), this will be detected as an ICE mismatch, and ICE processing is aborted for the call. This behavior of disabling ICE is not always desirable especially when one of the endpoints is behind a NAT.</p>
<p><a href="#RFC7092">[RFC7092]</a> describes three different categories of such B2BUAs, according to the level of activities performed on the media plane:</p>
<p/>

<dl>
  <dt></dt>
  <dd style="margin-left: 8">A B2BUA that acts as a simple media relay effectively unaware of anything that is transported and only modifies the transport header (could be UDP/IP) of the media packets.</dd>
  <dt></dt>
  <dd style="margin-left: 8">A B2BUA that performs a media-aware role. It inspects and potentially modifies RTP or RTP Control Protocol (RTCP) headers; but it does not modify the payload of RTP/RTCP.</dd>
  <dt></dt>
  <dd style="margin-left: 8">A B2BUA that performs a media-termination role and operates at the media payload layer, such as RTP/RTCP payload (e.g., a transcoder).</dd>
</dl>
<p id="rfc.section.1.p.6">When such a B2BUA operating on a media plane is involved a call between two endpoints that performs ICE, then it SHOULD follow the behavior mentioned in this specification.</p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#sec-term" id="sec-term">Terminology</a></h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<p id="rfc.section.2.p.2">The following generalized terms are defined in <a href="#RFC3261">[RFC3261]</a>, Section 6.</p>
<p/>

<dl>
  <dt></dt>
  <dd style="margin-left: 8">B2BUA: A SIP Back-to-Back User Agent, which is the logical combination of a User Agent Server (UAS) and User Agent Client (UAC).</dd>
  <dt></dt>
  <dd style="margin-left: 8">UAS: A SIP User Agent Server.</dd>
  <dt></dt>
  <dd style="margin-left: 8">UAC: A SIP User Agent Client.</dd>
</dl>
<p id="rfc.section.2.p.4">All of the pertinent B2BUA terminology and taxonomy used in this document is based on <a href="#RFC7092">[RFC7092]</a>.</p>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> Media Plane B2BUAs</h1>
<h1 id="rfc.section.3.1"><a href="#rfc.section.3.1">3.1.</a> Overview</h1>
<p id="rfc.section.3.1.p.1">When one or both the endpoints are behind NAT, and there is a B2BUA between the endpoints, it is desirable to have the B2BUA support ICE or at the minimum support ICE LITE functionality as described in <a href="#RFC5245">[RFC5245]</a>. Such B2BUAs MUST implement ICE and STUN and handle STUN messages sent by the endpoints on the media path. B2BUAs MUST use the mechanism described in section 5.1.2 of <a href="#RFC5764">[RFC5764]</a> to demultiplex STUN packets that arrive on the RTP/RTCP port.</p>
<p id="rfc.section.3.1.p.2">The subsequent sections describes the behavior B2BUA's MUST follow for handling STUN messages. A B2BUA MAY always terminate ICE and thus have two ICE contexts with either endpoints. A B2BUA MAY also be in ICE passthrough mode and passes across the candidate list from one endpoint to the other side. The below sections describes the behaviors for these two cases.</p>
<h1 id="rfc.section.3.2"><a href="#rfc.section.3.2">3.2.</a> ICE termination with B2BUA</h1>
<p id="rfc.section.3.2.p.1">A B2BUA that wishes to be alway in the media path MUST follow the below steps when it receives a SDP with ICE semantics. </p>
<p/>

<dl>
  <dt></dt>
  <dd style="margin-left: 8">When a B2BUA receives a SDP with ICE semantics it MUST respond with a SDP having ICE candidates. A B2BUA MAY be in ICE lite mode as described in section 2.7 of <a href="#RFC5245">[RFC5245]</a> in which case it MUST send a=ice-lite and MUST include host candidates for each component of each media stream.</dd>
  <dt></dt>
  <dd style="margin-left: 8">If the B2BUA supports full ICE, then it MAY include candidates of different types for each component of each media stream in the SDP offer/answer.</dd>
  <dt></dt>
  <dd style="margin-left: 8">A B2BUA when it sends out  SDP, it MUST advertise support for ICE and MAY include candidates of different types for each component of each media stream.</dd>
  <dt></dt>
  <dd style="margin-left: 8">The B2BUA MUST generate new username, password values for ice- ufrag and ice-pwd attributes when it sends out the SDP and MUST NOT propagate the ufrag/password values it received in the incoming SDP. This ensures that the short-term credentials used for both the legs are different. B2BUA terminates the STUN message on each leg, generates new STUN message using new cryptographically-random <a href="#RFC4086">[RFC4086]</a> STUN transaction ID and computes the message integrity for STUN messages using the new credentials.</dd>
  <dt></dt>
  <dd style="margin-left: 8">The B2BUA MUST generate and/or respond to ICE connectivity checks after offer/answer is completed.</dd>
</dl>
<div id="rfc.figure.1"/>
<div id="Figure1"/>
<pre>
 +-------+            +------------------+              +-----+         
 | Alice |            | Mediaplane B2BUA |              | Bob |
 +-------+            +------------------+              +-----+
     |(1) INVITE               |  (3)INVITE                |
     |   a=ice-ufrag1          |    a=ice-ufrag2           |
     |   a=ice-pwd1            |     a=ice-pwd2            |
     |   (alice's IP/port)     |   (B2BUA's IP, port)      |   
     |(Alice's candidate list )|   (B2BUA's candidate list)|                        
     |------------------------&gt;|--------------------------&gt;|
     |                         |                           |
     |    (2)  100 trying      |                           |
     |&lt;------------------------|                           |
     |                         | (4) 100 trying            |
     |                         |&lt;--------------------------|
     |                         |  (5)200 OK                |
     |                         |   a=ice-ufrag3            |
     |                         |    a=ice-pwd3             |
     |                         |  (Bob's IP, port)         |
     |                         | (Bob's candidate list)    |
     |                         | &lt;-------------------------|
     |    (6) 200 OK           |                           |
     |    a=ice-ufrag4         | ----------ACK------------&gt;|
     |    a=ice-pwd4           |           (7)             |
     |    B2BUA's address,port |                           |
     | (B2BUA's cand list1)    |                           |
     |&lt;------------------------|                           |
     | -------ACK-------------&gt;|                           |
     |              (8)        |                           |
     |                         |                           |
     |&lt;----ICE Connectivity 1-&gt;|                           |
     |      checks+conclusion  |&lt;-----ICE Connectivity 2--&gt;|
     |         (9)             |        checks +conclusion |
     |                         |         (10)              |
     |&lt;-------Media packets --&gt;|&lt;----Media packets--------&gt;|
     |      (13)               |         (14)              |  
     |                         |                           |
     |&lt;---ICE keepalives 1----&gt;|                           |
     |        (15)             |&lt;----ICE keep alives 2----&gt;|            
                                      (16)
          </pre>
<p class="figure">Figure 1: INVITE with SDP having ICE and with a Media Plane B2BUA</p>
<p/>
<p id="rfc.section.3.2.p.4">Above figure shows a sample call flow with two endpoints Alice and Bob doing ICE and a B2BUA handing STUN messages from both the endpoints. For the sake of brevity the entire ICE SDP attributes are not shown. Also the STUN messages exchanged as part of ICE connectivity checks are not shown. Key steps to note from the call flow are:</p>
<p/>

<ol>
  <li>Alice sends an INVITE with SDP having ICE candidates.</li>
  <li>B2BUA modifies the received SDP from Alice by removing the received candidates, gathers its own candidates, updates ice-ufrag, ice-password attributes with new username, password values and forwards the INVITE (3) to Bob.</li>
  <li>Bobs responds(5) to the INVITE with his own list of candidates. </li>
  <li>B2BUA responds to the INVITE from Alice with SDP having B2BUA's candidate list. B2BUA would also convey ice-ufrag, ice-password attributes with  new username, password values in the 200 OK response(6). </li>
  <li>ICE Connectivity checks happen between Alice and B2BUA in step 9.  Depending on whether the B2BUA supports ICE or ICE lite it will follow the appropriate procedures mentioned in <a href="#RFC5245">[RFC5245]</a>. The B2BUA MUST process the STUN request sent by Alice and respond to the same without forwarding it to the other side (Bob).</li>
  <li>ICE Connectivity checks also happen between Bob and B2BUA in step 10. Step 9, 10 happens in parallel and STUN messages on each side MUST NOT be forwarded to the other side by the B2BUA. </li>
  <li>Media flows between Alice and Bob via B2BUA (Step 13, 14). </li>
  <li>STUN keepalives would be used between Alice and B2BUA (step 15) and between Bob and B2BUA (step 16) to keep NAT, Firewall bindings alive. </li>
</ol>
<p id="rfc.section.3.2.p.6">Since there are two independent ICE agents on either side of the B2BUA it is possible that ICE checks will conclude on one side before concluding on the other side. This could result in an ongoing media session for one end, while the other is still being set up. Any such media received by the B2BUA would continue to be sent to the other side on the default candidate address (that was sent in c= line).</p>
<h1 id="rfc.section.3.3"><a href="#rfc.section.3.3">3.3.</a> STUN/ICE passthrough with B2BUA</h1>
<p id="rfc.section.3.3.p.1">When ICE is used by endpoints for determining a valid pair to send media and if a B2BUA is in the media path using the approach mentioned in previous sections would always lead to media flowing through B2BUA. To avoid this situation, a B2BUA can follow the steps mentioned below. Note if the B2BUA is terminating media (like Transcoder e.t.c) it MUST terminate ICE as well. </p>
<p/>

<dl>
  <dt></dt>
  <dd style="margin-left: 8">When a B2BUA receives a incoming SDP with ICE semantics it copies the received candidate list, adds its own candidate list and then sends the outgoing SDP.</dd>
  <dt></dt>
  <dd style="margin-left: 8">The B2BUA MUST propagate the ufrag/password values it received in the incoming SDP to the outbound SDP as it is. </dd>
  <dt></dt>
  <dd style="margin-left: 8">After offer/answer is complete, the endpoints would have both the B2BUA's candidate list and the peer endpoints candidate list. It would then use ICE procedures described in <a href="#RFC5245">[RFC5245]</a> to select a candidate pair for sending and receiving media streams. </dd>
</dl>
<div id="rfc.figure.2"/>
<div id="Figure2"/>
<pre>
 +-------+            +------------------+              +-----+         
 | Alice |            | Mediaplane B2BUA |              | Bob |
 +-------+            +------------------+              +-----+
     |(1) INVITE               |  (3)INVITE                |
     |   a=ice-ufrag1          |    a=ice-ufrag1           |
     |   a=ice-pwd1            |     a=ice-pwd1            |
     |  (alice's IP/port)      | (Alices's IP, port)       |   
     |(Alice's candidate list )| (Alice's Candidate list + |
                               |   B2BUA's candidate list1)|                        
     |------------------------&gt;|--------------------------&gt;|
     |                         |                           |
     |    (2)  100 trying      |                           |
     |&lt;------------------------|                           |
     |                         | (4) 100 trying            |
     |                         |&lt;--------------------------|
     |                         |  (5)200 OK                |
     |                         |   a=ice-ufrag2            |
     |                         |    a=ice-pwd2             |
     |                         |  (Bob's IP, port)         |
     |                         | (Bob's candidate list)    |
     |                         | &lt;-------------------------|
     |    (6) 200 OK           |                           |
     |    a=ice-ufrag2         | ----------ACK------------&gt;|
     |    a=ice-pwd2           |           (7)             |
     | (Bobs's IP,port)        |                           |
     | (B2BUA's cand list2 +   |                           |
     |   Bob's Candidate list) |                           |
     |&lt;------------------------|                           |
     | -------ACK-------------&gt;|                           |
     |              (8)        |                           |
     |                         |                           |
     |&lt;----ICE Connectivity 1 (9)-------------------------&gt;| 
     |                         |                           |
     |&lt;----ICE Connectivity 2-&gt;|                           |
     |      checks+conclusion  |&lt;-----ICE Connectivity 2--&gt;|
     |         (10)             |        checks +conclusion|
     |                         |         (11)              |
     |&lt;-------------------Media packets-------------------&gt;|
     |                      (12)                           |
     |                         |                           |
     |&lt;---------ICE keepalives----------------------------&gt;|          
                                      (13)
          </pre>
<p class="figure">Figure 2: INVITE with SDP having ICE and with a Media Plane B2BUA in ICE Passthrough mode</p>
<p/>
<p id="rfc.section.3.3.p.4">Above figure shows a sample call flow with two endpoints Alice and Bob doing ICE and a B2BUA handing STUN messages from both the endpoints. For the sake of brevity the entire ICE SDP attributes are not shown. Also the STUN messages exchanged as part of ICE connectivity checks are not shown. Key steps to note from the call flow are:</p>
<p/>

<ol>
  <li>Alice sends an INVITE with SDP having ICE candidates.</li>
  <li>B2BUA propagates the received candidate list in SDP from Alice after adding its own candidate list. B2BUA also propagates the received ice-ufrag, ice-password attributes from Alice and forwards in  the INVITE (3) to Bob. In this example call flow,the B2BUA does not change the c-line IP in the received SDP and propagates the received IP address from Alice in C-line as is to Bob. However it is possible that a B2BUA puts its IP address in the C-line to indicate that as a preferred address before forwarding the INVITE.</li>
  <li>Bobs responds(5) to the INVITE with his own list of candidates. </li>
  <li>B2BUA responds to the INVITE from Alice with SDP having B2BUA's candidate list and the candidate list received from Bob. B2BUA would also propagate the received ice-ufrag, ice-password attributes from Bob in step (5) to Alice in the 200 OK response(6). </li>
  <li>ICE Connectivity checks happen between Alice and Bob in step 9. ICE Connectivity checks also happens between Alice and B2BUA and Bob and B2BUA as shown in step 10, 11. Step 9, 10, 11 MAY happen in parallel. In this example Alice and Bob concludes ICE with a candidate pair that enables them to send media directly between them.</li>
  <li>Media flows between Alice and Bob in Step 12. </li>
  <li>STUN keepalives would be used between Alice and Bob (step 13) to keep NAT, Firewall bindings alive. </li>
</ol>
<h1 id="rfc.section.3.4"><a href="#rfc.section.3.4">3.4.</a> STUN interaction with DTLS-SRTP in B2BUA</h1>
<p><a href="#I-D.ram-straw-b2bua-dtls-srtp">[I-D.ram-straw-b2bua-dtls-srtp]</a>describes the behavior of B2BUAs when DTLS-SRTP <a href="#RFC5764">[RFC5764]</a> is used by Session Initiation Protocol (SIP) <a href="#RFC3261">[RFC3261]</a> endpoints to establish a Secure Real-time Transport Protocol (SRTP) <a href="#RFC3711">[RFC3711]</a> session. When ICE is used by such endpoints, it needs to take care of the following things:</p>
<p/>

<dl>
  <dt></dt>
  <dd style="margin-left: 8">If Aggressive nomination is used in ICE, DTLS session is setup as soon as connectivity check for a media stream is complete. If a different candidate pair is selected after ICE conclusion, then the previously setup DTLS session could be re-used using session resumption as mentioned in Appendix B of <a href="#RFC5764">[RFC5764]</a>.</dd>
</dl>
<div id="rfc.figure.3"/>
<div id="Figure3"/>
<pre>
   +------+          +-------------------+             +-------+
   | Alice|          | Media Plane B2BUA |             |   Bob |
   +------+          +-------------------+             +-------+
     |(1) INVITE               |  (3)INVITE                |
     |   a=ice-ufrag1          |    a=ice-ufrag2           |
     |   a=ice-pwd1            |     a=ice-pwd2            |
     |   a=setup:actpass       |   a=setup:actpass         |
     |   a=fingerprint1        |   a= fingerprint1         | 
     |   (alice's IP/port)     |   (B2BUA's IP, port)      |   
     |(Alice's candidate list )|   (B2BUA's candidate list)|                                
     |------------------------&gt;|  ------------------------&gt;|
     |                         |                           |
     |    (2)  100 trying      |                           |
     | &lt;-----------------------|                           |
     |                         | (4) 100 trying            |
     |                         | &lt;-------------------------|
     |                         |                           |
     |                         |  (5)200 OK                |
     |                         |   a=ice-ufrag3            |
     |                         |    a=ice-pwd3             |
     |                         |   a=setup:active          |
     |                         |    a=fingerprint2         |
     |                         |  (Bob's IP, port)         |
     |                         | (Bob's candidate list)    |
     |                         | &lt;-------------------------|
     |    (6) 200 OK           |                           |
     |    a=ice-ufrag4         | -------ACK---------------&gt;|
     |    a=ice-pwd4           |                           |
     |    a=setup:active       |                           |
     |    a=fingerprint2       |                           |
     |    B2BUA's address,port |                           |
     | (B2BUA's cand list1)    |                           |
     |&lt;------------------------|                           |
     | -------ACK-------------&gt;|                           |
     |                         |                           |
     |&lt;----ICE Connectivity---&gt;|                           |
     |      checks+conclusion  |&lt;-----ICE Connectivity----&gt;|
     |         (7)             |        checks +conclusion |
     |                         |          (8)              |
     |                         |                           |
     |    (9)    ClientHello + use_srtp on nominated pair  |
     |&lt;------------------------|&lt;--------------------------|
     |                         |                           |
     |           (10)    ServerHello + use_srtp            |
     | -----------------------&gt;|--------------------------&gt;|
     |                 (11)    |                           |
     |  [Certificate exchange between Alice and Bob over   | 
     |   DTLS or DTLS-SRTP channel as described in RFC5764]|  
     |                         |                           |
     |                         |                           |
     |&lt;---------SRTP/SRTCP----&gt;|&lt;----SRTP/SRTCP-----------&gt;|
     |                 (12)    |      (13)                 |   
     |   [B2BUA just changes UDP/IP header]                | 
     
       </pre>
<p class="figure">Figure 3: INVITE with SDP having both ICE and DTLS and with a Media relay B2BUA</p>
<p/>
<p id="rfc.section.3.4.p.4">Below call flows shows a example of how a B2BUA works when both DTLS and ICE are used. In this example, the B2BUA is in media relay mode for DTLS session and passes across the fingerprint attribute in SDP from Alice to Bob without any modification.</p>
<p id="rfc.section.3.4.p.5">The above example shows a call flow where endpoints use ICE and DTLS..  The example here shows an early offer call, however the same is applicable for delay media scenarios as well.  For the sake of brevity the entire candidate list is not shown.  After ICE concludes, DTLS session is setup. DTLS session can be re-used across multiple media streams using session resumption.  DTLS-SRTP RFC also allows peers to establish multiple DTLS sessions, refer to Appendix of <a href="#RFC5764">[RFC5764]</a> for alternative approach.</p>
<h1 id="rfc.section.3.5"><a href="#rfc.section.3.5">3.5.</a> STUN Handling in B2BUA with Forked Signaling</h1>
<p id="rfc.section.3.5.p.1">B2BUA's may receive multiple answers for an outbound INVITE due to a downstream proxy forking the INVITE to multiple targets. It is possible that each of these responses have ICE parameters signaled in the SDP. In such cases, the B2BUA SHOULD take care of doing ICE connectivity checks for each of the forked target.</p>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> Security Considerations</h1>
<p id="rfc.section.4.p.1">TBA</p>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#sec.iana-considerations" id="sec.iana-considerations">IANA Considerations</a></h1>
<p id="rfc.section.5.p.1">This document makes no request of IANA.</p>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> Acknowledgments</h1>
<p id="rfc.section.6.p.1">TBD</p>
<h1 id="rfc.references"><a href="#rfc.references">7.</a> References</h1>
<h1 id="rfc.references.1"><a href="#rfc.references.1">7.1.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="RFC2119">[RFC2119]</b>
      </td>
      <td class="top"><a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3711">[RFC3711]</b>
      </td>
      <td class="top"><a>Baugher, M.</a>, <a>McGrew, D.</a>, <a>Naslund, M.</a>, <a>Carrara, E.</a> and <a>K. Norrman</a>, "<a href="http://tools.ietf.org/html/rfc3711">The Secure Real-time Transport Protocol (SRTP)</a>", RFC 3711, March 2004.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4086">[RFC4086]</b>
      </td>
      <td class="top"><a>Eastlake, D.</a>, <a>Schiller, J.</a> and <a>S. Crocker</a>, "<a href="http://tools.ietf.org/html/rfc4086">Randomness Requirements for Security</a>", BCP 106, RFC 4086, June 2005.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5245">[RFC5245]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, "<a href="http://tools.ietf.org/html/rfc5245">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>", RFC 5245, April 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5389">[RFC5389]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, <a>Mahy, R.</a>, <a>Matthews, P.</a> and <a>D. Wing</a>, "<a href="http://tools.ietf.org/html/rfc5389">Session Traversal Utilities for NAT (STUN)</a>", RFC 5389, October 2008.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5763">[RFC5763]</b>
      </td>
      <td class="top"><a>Fischl, J.</a>, <a>Tschofenig, H.</a> and <a>E. Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5763">Framework for Establishing a Secure Real-time Transport Protocol (SRTP) Security Context Using Datagram Transport Layer Security (DTLS)</a>", RFC 5763, May 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5764">[RFC5764]</b>
      </td>
      <td class="top"><a>McGrew, D.</a> and <a>E. Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5764">Datagram Transport Layer Security (DTLS) Extension to Establish Keys for the Secure Real-time Transport Protocol (SRTP)</a>", RFC 5764, May 2010.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.references.2"><a href="#rfc.references.2">7.2.</a> Informative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="I-D.ram-straw-b2bua-dtls-srtp">[I-D.ram-straw-b2bua-dtls-srtp]</b>
      </td>
      <td class="top"><a>R, R.</a>, <a>Reddy, T.</a>, <a>Salgueiro, G.</a> and <a>V. Pascual</a>, "<a href="http://tools.ietf.org/html/draft-ram-straw-b2bua-dtls-srtp-00">DTLS-SRTP Handling in Session Initiation Protocol (SIP) Back-to-Back User Agents (B2BUAs)</a>", Internet-Draft draft-ram-straw-b2bua-dtls-srtp-00, June 2014.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3261">[RFC3261]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, <a>Schulzrinne, H.</a>, <a>Camarillo, G.</a>, <a>Johnston, A.</a>, <a>Peterson, J.</a>, <a>Sparks, R.</a>, <a>Handley, M.</a> and <a>E. Schooler</a>, "<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>", RFC 3261, June 2002.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4566">[RFC4566]</b>
      </td>
      <td class="top"><a>Handley, M.</a>, <a>Jacobson, V.</a> and <a>C. Perkins</a>, "<a href="http://tools.ietf.org/html/rfc4566">SDP: Session Description Protocol</a>", RFC 4566, July 2006.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7092">[RFC7092]</b>
      </td>
      <td class="top"><a>Kaplan, H.</a> and <a>V. Pascual</a>, "<a href="http://tools.ietf.org/html/rfc7092">A Taxonomy of Session Initiation Protocol (SIP) Back-to-Back User Agents</a>", RFC 7092, December 2013.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Authors' Addresses</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Ram Mohan Ravindranath</span> 
	  <span class="n hidden">
		<span class="family-name">Ravindranath</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco</span>
	<span class="adr">
	  <span class="vcardline">Cessna Business Park</span>
<span class="vcardline">Sarjapur-Marathahalli Outer Ring Road</span>

	  <span class="vcardline">
		<span class="locality">Bangalore</span>,  
		<span class="region">Karnataka</span> 
		<span class="code">560103</span>
	  </span>
	  <span class="country-name vcardline">India</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:rmohanr@cisco.com">rmohanr@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Tirumaleswar Reddy</span> 
	  <span class="n hidden">
		<span class="family-name">Reddy</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco</span>
	<span class="adr">
	  <span class="vcardline">Cessna Business Park, Varthur Hobli</span>
<span class="vcardline">Sarjapur Marathalli Outer Ring Road</span>

	  <span class="vcardline">
		<span class="locality">Bangalore</span>,  
		<span class="region">Karnataka</span> 
		<span class="code">560103</span>
	  </span>
	  <span class="country-name vcardline">India</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:tireddy@cisco.com">tireddy@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Gonzalo Salgueiro</span> 
	  <span class="n hidden">
		<span class="family-name">Salgueiro</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span class="vcardline">7200-12 Kit Creek Road</span>

	  <span class="vcardline">
		<span class="locality">Research Triangle Park</span>,  
		<span class="region">NC</span> 
		<span class="code">27709</span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:gsalguei@cisco.com">gsalguei@cisco.com</a></span>

  </address>
</div>

</body>
</html>
