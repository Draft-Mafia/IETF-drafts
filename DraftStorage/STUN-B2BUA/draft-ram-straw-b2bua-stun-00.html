<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>STUN Message Handling for Session Initiation Protocol (SIP) Back-to-Back User Agents (B2BUAs)</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
      /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
      a.info {
          /* This is the key. */
          position: relative;
          z-index: 24;
          text-decoration: none;
      }
      a.info:hover {
          z-index: 25;
          color: #FFF; background-color: #900;
      }
      a.info span { display: none; }
      a.info:hover span.info {
          /* The span will display just on :hover state. */
          display: block;
          position: absolute;
          font-size: smaller;
          top: 2em; left: -5em; width: 15em;
          padding: 2px; border: 1px solid #333;
          color: #900; background-color: #EEE;
          text-align: left;
      }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  max-width: 55em;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology"/>
<link href="#rfc.section.3" rel="Chapter" title="3 Media Plane B2BUAs"/>
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Overview"/>
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 ICE Termination with B2BUA"/>
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 ICE Passthrough with B2BUAs "/>
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 STUN Handling in B2BUA with Forked Signaling"/>
<link href="#rfc.section.4" rel="Chapter" title="4 Security Considerations"/>
<link href="#rfc.section.5" rel="Chapter" title="5 IANA Considerations"/>
<link href="#rfc.section.6" rel="Chapter" title="6 Acknowledgments"/>
<link href="#rfc.references" rel="Chapter" title="7 References"/>
<link href="#rfc.references.1" rel="Chapter" title="7.1 Normative References"/>
<link href="#rfc.references.2" rel="Chapter" title="7.2 Informative References"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.4.7 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Ravindranath, R., Reddy, T., and G. Salgueiro" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-ram-straw-b2bua-stun-00" />
  <meta name="dct.issued" scheme="ISO8601" content="2014-7-3" />
  <meta name="dct.abstract" content="SIP Back-to-Back User Agents (B2BUAs) are often designed to be on the media path, rather than just intercepting signaling.  This means that B2BUAs often act on the media path leading to separate media legs that the B2BUA correlates and bridges together. When acting on the media path, B2BUAs are likely to receive STUN packets as part of Interactive Connectivity Establishment (ICE) processing. It is critical that B2BUAs handle these STUN messages properly." />
  <meta name="description" content="SIP Back-to-Back User Agents (B2BUAs) are often designed to be on the media path, rather than just intercepting signaling.  This means that B2BUAs often act on the media path leading to separate media legs that the B2BUA correlates and bridges together. When acting on the media path, B2BUAs are likely to receive STUN packets as part of Interactive Connectivity Establishment (ICE) processing. It is critical that B2BUAs handle these STUN messages properly." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">STRAW</td>
  <td class="right">R. Ravindranath</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">T. Reddy</td>
</tr>
<tr>
  <td class="left">Intended status: Standards Track</td>
  <td class="right">G. Salgueiro</td>
</tr>
<tr>
  <td class="left">Expires: January 4, 2015</td>
  <td class="right">Cisco</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">July 3, 2014</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">STUN Message Handling for Session Initiation Protocol (SIP) Back-to-Back User Agents (B2BUAs)<br />
  <span class="filename">draft-ram-straw-b2bua-stun-00</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>SIP Back-to-Back User Agents (B2BUAs) are often designed to be on the media path, rather than just intercepting signaling.  This means that B2BUAs often act on the media path leading to separate media legs that the B2BUA correlates and bridges together. When acting on the media path, B2BUAs are likely to receive STUN packets as part of Interactive Connectivity Establishment (ICE) processing. It is critical that B2BUAs handle these STUN messages properly.</p>
<p>This document defines behavior for a B2BUA performing ICE processing. </p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on January 4, 2015.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2014 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<li>2.   <a href="#rfc.section.2">Terminology</a></li>
<li>3.   <a href="#rfc.section.3">Media Plane B2BUAs</a></li>
<li>3.1.   <a href="#rfc.section.3.1">Overview</a></li>
<li>3.2.   <a href="#rfc.section.3.2">ICE Termination with B2BUA</a></li>
<li>3.3.   <a href="#rfc.section.3.3">ICE Passthrough with B2BUAs </a></li>
<li>3.4.   <a href="#rfc.section.3.4">STUN Handling in B2BUA with Forked Signaling</a></li>
<li>4.   <a href="#rfc.section.4">Security Considerations</a></li>
<li>5.   <a href="#rfc.section.5">IANA Considerations</a></li>
<li>6.   <a href="#rfc.section.6">Acknowledgments</a></li>
<li>7.   <a href="#rfc.references">References</a></li>
<li>7.1.   <a href="#rfc.references.1">Normative References</a></li>
<li>7.2.   <a href="#rfc.references.2">Informative References</a></li>
<li><a href="#rfc.authors">Authors' Addresses</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> Introduction</h1>
<p id="rfc.section.1.p.1">In many SIP deployments, SIP entities exist in the SIP signaling path between the originating and final terminating endpoints, which go beyond the definition of a SIP proxy, performing functions not defined in Standards Track RFCs. These SIP entities, commonly known as Back-to-Back User Agents (B2BUAs) are described in <a href="#RFC7092">[RFC7092]</a>.</p>
<p id="rfc.section.1.p.2">The Session Initiation Protocol (SIP) <a href="#RFC3261">[RFC3261]</a>, and others that try to use a more direct path for media than with signaling, are difficult to use across NATs.  These protocols use IP addresses and transport port numbers encoded in bodies such as the Session Description Protocol (SDP) <a href="#RFC4566">[RFC4566]</a> and, in the case of SIP, various header fields.  Such addresses and ports are unusable unless all peers in a session are located behind the same NAT.</p>
<p id="rfc.section.1.p.3">Mechanisms such as Session Traversal Utilities for NAT (STUN) <a href="#RFC5389">[RFC5389]</a> , Traversal Using Relays around NAT (TURN) <a href="#RFC5766">[RFC5766]</a> , and Interactive Connectivity Establishment (ICE) <a href="#RFC5245">[RFC5245]</a> did not exist when protocols like SIP began being deployed.  Some mechanisms, such as the early versions of STUN <a href="#RFC3489">[RFC3489]</a>, had started appearing but they were unreliable and suffered a number of issues typical for UNilateral Self-Address Fixing (UNSAF) and described in <a href="#RFC3424">[RFC3424]</a>. For these and other reasons, Session Border Controllers (SBCs) that were already being used by SIP domains for other SIP and media- related purposes began to use proprietary mechanisms to enable SIP devices behind NATs to communicate across the NAT. <a href="#I-D.ietf-mmusic-latching">[I-D.ietf-mmusic-latching]</a> describes how B2BUAs can perform Hosted NAT traversal (HNT) to solve the NAT traversal problem.</p>
<p id="rfc.section.1.p.4">Section 5 of <a href="#I-D.ietf-mmusic-latching">[I-D.ietf-mmusic-latching]</a> describes some of the issues with SBCs implementing HNT and mitigation approaches. The most commonly used approach to solve these issues is  "restricted-latching" whereby the B2BUA will not latch to any packets from a source public IP address other than the one the SIP UA uses for SIP signalling is one solution. However, this is susceptible to attacks, where a attacker who gets to see the Source IP address of the SIP UA may generate packets using the same IP address.  There are other threats described in the same section 5 of <a href="#I-D.ietf-mmusic-latching">[I-D.ietf-mmusic-latching]</a>  for which SRTP can be used to solve. However, this would require the B2BUAs to be terminating/re-originating SRTP which is not always the case. A B2BUA can use ICE <a href="#RFC5245">[RFC5245]</a> which provides authentication tokens (conveyed in the ice- ufrag and ice-pwd attributes) that allows the identity of a peer to be confirmed before engaging in media exchange. This can solve some of the security concerns with HNT solution. Further, ICE has other benefits like selecting a address when more than one address are available (dual-stack case), verifying that a path works before connecting the call e.t.c. For these reasons endpoints often use ICE and it is preferable to have ICE work end to end even when there are B2BUAs in the path.</p>
<p id="rfc.section.1.p.5">B2BUAs modify SIP headers, SDP bodies and also are likely to be on the media path. Such entities, when present in the media path, are likely to do several things. For example, some B2BUAs modify parts of the SDP body (like IP address, port) and subsequently modify the media packet headers as well.  There are other types of B2BUAs that completely modify the media payload  (e.g., a media transcoder).</p>
<p id="rfc.section.1.p.6">Section 18.6 of ICE <a href="#RFC5245">[RFC5245]</a> explains two different behaviors when B2BUAs are present.  Some B2BUAs are likely to remove all the SDP ICE attributes before sending the SDP across to the other side.  Consequently, the call will appear to both endpoints as though the other side doesn't support ICE.  There are other types of B2BUAs that pass the ICE attributes without modification, yet modify the default destination for media (contained in the m= and c= lines and rtcp attribute), this will be detected as an ICE mismatch, and ICE processing is aborted for the call. The call may continue if the endpoints are able to reach each other over the default candidate (sent in c= m= lines).</p>
<p><a href="#RFC7092">[RFC7092]</a> describes three different categories of such B2BUAs, according to the level of activities performed on the media plane:</p>
<p/>

<dl>
  <dt></dt>
  <dd style="margin-left: 8">A B2BUA that acts as a simple media relay effectively unaware of anything that is transported and only modifies the transport header (could be UDP/IP) of the media packets.</dd>
  <dt></dt>
  <dd style="margin-left: 8">A B2BUA that performs a media-aware role. It inspects and potentially modifies RTP or RTP Control Protocol (RTCP) headers; but it does not modify the payload of RTP/RTCP.</dd>
  <dt></dt>
  <dd style="margin-left: 8">A B2BUA that performs a media-termination role and operates at the media payload layer, such as RTP/RTCP payload (e.g., a transcoder).</dd>
</dl>
<p id="rfc.section.1.p.9">When such a B2BUA operating on a media plane is involved in a call between two endpoints performing ICE, then it SHOULD follow the behavior described in this specification.</p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#sec-term" id="sec-term">Terminology</a></h1>
<p id="rfc.section.2.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<p id="rfc.section.2.p.2">The following generalized terms are defined in <a href="#RFC3261">[RFC3261]</a>, Section 6.</p>
<p/>

<dl>
  <dt></dt>
  <dd style="margin-left: 8">B2BUA: A SIP Back-to-Back User Agent, which is the logical combination of a User Agent Server (UAS) and User Agent Client (UAC).</dd>
  <dt></dt>
  <dd style="margin-left: 8">UAS: A SIP User Agent Server.</dd>
  <dt></dt>
  <dd style="margin-left: 8">UAC: A SIP User Agent Client.</dd>
</dl>
<p id="rfc.section.2.p.4">All of the pertinent B2BUA terminology and taxonomy used in this document is based on <a href="#RFC7092">[RFC7092]</a>.</p>
<p id="rfc.section.2.p.5">Network Address Translators (NATs) are widely used in the Internet by consumers and organizations.  Although specific NAT behaviors vary, this document uses the term "NAT", which maps to NAT and NAPT terms from <a href="#RFC3022">[RFC3022]</a>, for devices that map any IPv4 or IPv6 address and transport port number to another IPv4 or IPv6 address and transport port number.  This includes consumer NATs, Firewall-NATs, IPv4-IPv6 NATs, Carrier-Grade NATs (CGNs) <a href="#RFC6888">[RFC6888]</a>, etc.  </p>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> Media Plane B2BUAs</h1>
<h1 id="rfc.section.3.1"><a href="#rfc.section.3.1">3.1.</a> Overview</h1>
<p id="rfc.section.3.1.p.1">When one or both of the endpoints are behind a NAT, and there is a B2BUA between the endpoints, it is desirable to have the B2BUA support ICE or at minimum support ICE LITE functionality as described in <a href="#RFC5245">[RFC5245]</a>. Such B2BUAs MUST implement ICE handle ICE messages sent by the endpoints on the media path. B2BUAs MUST use the mechanism described in section 2.2 of <a href="#RFC5245">[RFC5245]</a> to demultiplex STUN packets that arrive on the Real-time Transport Protocol(RTP)/RTP Control Protocol (RTCP) port.</p>
<p id="rfc.section.3.1.p.2">The subsequent sections describes the behavior B2BUA's MUST follow for handling ICE messages. A B2BUA can always terminate ICE and thus have two ICE contexts with either endpoint. The reason for ICE termination could be due to the need for B2BUA to be always in the media path ( for e.g. to do media transcoding, media recording, address hiding) e.t.c. A B2BUA can also be in ICE passthrough mode and passes across the candidate list from one endpoint to the other side. A B2BUA may be in ICE passthrough mode when it does not have a need to be in media path. The below sections describes the behaviors for these two cases.</p>
<h1 id="rfc.section.3.2"><a href="#rfc.section.3.2">3.2.</a> ICE Termination with B2BUA</h1>
<p id="rfc.section.3.2.p.1">A B2BUA that wishes to be always in the media path follows the below steps: </p>
<p/>

<dl>
  <dt></dt>
  <dd style="margin-left: 8">When a B2BUA sends out a SDP, it MUST advertise support for ICE and MAY include candidates of different types for each component of each media stream.</dd>
  <dt></dt>
  <dd style="margin-left: 8">If the B2BUA is in ICE lite mode as described in section 2.7 of <a href="#RFC5245">[RFC5245]</a> , then it MUST send a=ice-lite and MUST include only host candidates for each component of each media stream.</dd>
  <dt></dt>
  <dd style="margin-left: 8">If the B2BUA supports full ICE, then it MAY include candidates of different types for each component of each media stream.</dd>
  <dt></dt>
  <dd style="margin-left: 8">The B2BUA MUST generate new username, password values for ice- ufrag and ice-pwd attributes when it sends out the SDP and MUST NOT propagate the ufrag/password values it received in the incoming SDP. This ensures that the short-term credentials used for both the legs are different. The short-term credentials include authentication tokens (conveyed in the ice- ufrag and ice-pwd attributes), which the B2BUA can use to verify the identity of the peer.</dd>
  <dt></dt>
  <dd style="margin-left: 8">The B2BUA MUST NOT propagate the candidate list received in the incoming SDP to the outbound SDP and instead only advertise its candidate list. In this way the B2BUA will be always in media path. </dd>
  <dt></dt>
  <dd style="margin-left: 8">Depending on whether the B2BUA supports ICE lite or full ICE it implements the appropriate procedures mentioned in <a href="#RFC5245">[RFC5245]</a> for ICE connectivity checks.  B2BUA terminates the ICE messages on each leg and does not propagate them.</dd>
</dl>
<div id="rfc.figure.1"/>
<div id="Figure1"/>
<pre>
 +-------+            +------------------+              +-----+         
 | Alice |            | Mediaplane B2BUA |              | Bob |
 +-------+            +------------------+              +-----+
     |(1) INVITE               |  (3)INVITE                |
     |   a=ice-ufrag1          |    a=ice-ufrag2           |
     |   a=ice-pwd1            |     a=ice-pwd2            |
     |   (alice's IP/port)     |   (B2BUA's IP, port)      |   
     |(Alice's candidate list )|   (B2BUA's candidate list)|                        
     |------------------------&gt;|--------------------------&gt;|
     |                         |                           |
     |    (2)  100 trying      |                           |
     |&lt;------------------------|                           |
     |                         | (4) 100 trying            |
     |                         |&lt;--------------------------|
     |                         |  (5)200 OK                |
     |                         |   a=ice-ufrag3            |
     |                         |    a=ice-pwd3             |
     |                         |  (Bob's IP, port)         |
     |                         | (Bob's candidate list)    |
     |                         | &lt;-------------------------|
     |    (6) 200 OK           |                           |
     |    a=ice-ufrag4         | ----------ACK------------&gt;|
     |    a=ice-pwd4           |           (7)             |
     |    B2BUA's address,port |                           |
     | (B2BUA's cand list1)    |                           |
     |&lt;------------------------|                           |
     | -------ACK-------------&gt;|                           |
     |              (8)        |                           |
     |                         |                           |
     |&lt;----ICE Connectivity 1-&gt;|                           |
     |      checks+conclusion  |&lt;-----ICE Connectivity 2--&gt;|
     |         (9)             |        checks +conclusion |
     |                         |         (10)              |
     |&lt;-------Media packets --&gt;|&lt;----Media packets--------&gt;|
     |      (13)               |         (14)              |  
     |                         |                           |
     |&lt;---ICE keepalives 1----&gt;|                           |
     |        (15)             |&lt;----ICE keep alives 2----&gt;|            
                                      (16)
          </pre>
<p class="figure">Figure 1: INVITE with SDP having ICE and with a Media Plane B2BUA</p>
<p/>
<p id="rfc.section.3.2.p.4">Above figure shows a sample call flow with two endpoints Alice and Bob doing ICE and a B2BUA handing STUN messages from both the endpoints. For the sake of brevity the entire ICE SDP attributes are not shown. Also the STUN messages exchanged as part of ICE connectivity checks are not shown. Key steps to note from the call flow are:</p>
<p/>

<ol>
  <li>Alice sends an INVITE with SDP having ICE candidates.</li>
  <li>B2BUA modifies the received SDP from Alice by removing the received candidate list, gathers its own candidates, generate new username, password values for ice- ufrag and ice-pwd attributes and forwards the INVITE (3) to Bob.</li>
  <li>Bobs responds (5) to the INVITE with his own list of candidates. </li>
  <li>B2BUA responds to the INVITE from Alice with SDP having B2BUA's candidate list. B2BUA generate new username, password values for ice- ufrag and ice-pwd attributes in the 200 OK response (6). </li>
  <li>ICE Connectivity checks happen between Alice and the B2BUA in step 9.  Depending on whether the B2BUA supports ICE or ICE lite it will follow the appropriate procedures mentioned in <a href="#RFC5245">[RFC5245]</a>. ICE Connectivity checks also happen between Bob and the B2BUA in step 10. Step 9, 10 happens in parallel. The B2BUA always terminates the ICE messages on each leg has two independent ICE contexts running.</li>
  <li>Media flows between Alice and Bob via B2BUA (Step 13, 14). </li>
  <li>STUN keepalives would be used between Alice and B2BUA (step 15) and between Bob and B2BUA (step 16) to keep NAT, Firewall bindings alive. </li>
</ol>
<p id="rfc.section.3.2.p.6">Since there are two independent ICE contexts on either side of the B2BUA it is possible that ICE checks will conclude on one side before concluding on the other side. This could result in an ongoing media session for one end, while the other is still being set up. Any such media received by the B2BUA would continue to be sent to the other side on the default candidate address (that was sent in c= line).</p>
<h1 id="rfc.section.3.3"><a href="#rfc.section.3.3">3.3.</a> ICE Passthrough with B2BUAs </h1>
<p id="rfc.section.3.3.p.1">If a B2BUA does not see a need to be in media path, it can do the steps mentioned in this section. </p>
<p/>

<dl>
  <dt></dt>
  <dd style="margin-left: 8">When a B2BUA receives an incoming SDP with ICE semantics it copies the received candidate list, adds its own candidate list in the outgoing SDP.The B2BUA also copies the ufrag/password values it received in the incoming SDP to the outgoing SDP and then sends out the SDP. </dd>
  <dt></dt>
  <dd style="margin-left: 8">The priority of the B2BUAs candidates will be set in such a way that the endpoints ICE procedures treat the B2BUA candidates as least-preferred over the peer endpoints candidate list.</dd>
  <dt></dt>
  <dd style="margin-left: 8">After offer/answer is complete, the endpoints will have both the B2BUA's candidate list and the peer endpoints candidate list. It will then use ICE procedures described in <a href="#RFC5245">[RFC5245]</a> to select a candidate pair for sending and receiving media streams. </dd>
  <dt></dt>
  <dd style="margin-left: 8">With this approach the B2BUA will be in media path only if the ICE checks between all the candidate pairs formed from the both the endpoints fails. </dd>
</dl>
<div id="rfc.figure.2"/>
<div id="Figure2"/>
<pre>
 +-------+            +------------------+              +-----+         
 | Alice |            | Mediaplane B2BUA |              | Bob |
 +-------+            +------------------+              +-----+
     |(1) INVITE               |  (3)INVITE                |
     |   a=ice-ufrag1          |    a=ice-ufrag1           |
     |   a=ice-pwd1            |     a=ice-pwd1            |
     |  (alice's IP/port)      | (Alices's IP, port)       |   
     |(Alice's candidate list )| (Alice's Candidate list + |
                               |   B2BUA's candidate list1)|                        
     |------------------------&gt;|--------------------------&gt;|
     |                         |                           |
     |    (2)  100 trying      |                           |
     |&lt;------------------------|                           |
     |                         | (4) 100 trying            |
     |                         |&lt;--------------------------|
     |                         |  (5)200 OK                |
     |                         |   a=ice-ufrag2            |
     |                         |    a=ice-pwd2             |
     |                         |  (Bob's IP, port)         |
     |                         | (Bob's candidate list)    |
     |                         | &lt;-------------------------|
     |    (6) 200 OK           |                           |
     |    a=ice-ufrag2         | ----------ACK------------&gt;|
     |    a=ice-pwd2           |           (7)             |
     | (Bobs's IP,port)        |                           |
     | (B2BUA's cand list2 +   |                           |
     |   Bob's Candidate list) |                           |
     |&lt;------------------------|                           |
     | -------ACK-------------&gt;|                           |
     |              (8)        |                           |
     |                         |                           |
     |&lt;----ICE Connectivity 1 (9)-------------------------&gt;| 
     |                         |                           |
     |&lt;----ICE Connectivity 2-&gt;|                           |
     |      checks+conclusion  |&lt;-----ICE Connectivity 2--&gt;|
     |         (10)             |        checks +conclusion|
     |                         |         (11)              |
     |&lt;-------------------Media packets-------------------&gt;|
     |                      (12)                           |
     |                         |                           |
     |&lt;---------ICE keepalives----------------------------&gt;|          
                                      (13)
          </pre>
<p class="figure">Figure 2: INVITE with SDP having ICE and with a Media Plane B2BUA in ICE Passthrough mode</p>
<p/>
<p id="rfc.section.3.3.p.4">Above figure shows a sample call flow with two endpoints Alice and Bob doing ICE and a B2BUA handing STUN messages from both the endpoints. For the sake of brevity the entire ICE SDP attributes are not shown. Also the STUN messages exchanged as part of ICE connectivity checks are not shown. Key steps to note from the call flow are:</p>
<p/>

<ol>
  <li>Alice sends an INVITE with an DP having its own candidate list.</li>
  <li>B2BUA propagates the received candidate list in incoming SDP from Alice after adding its own candidate list. The B2BUA also propagates the received ice-ufrag, ice-password attributes from Alice and forwards in  the INVITE (3) to Bob. </li>
  <li>Bobs responds (5) to the INVITE with his own list of candidates. </li>
  <li>B2BUA responds to the INVITE from Alice with an SDP having B2BUA's candidate list and the candidate list received from Bob. The B2BUA would also propagate the received ice-ufrag, ice-password attributes from Bob in step (5) to Alice in the 200 OK response (6). </li>
  <li>ICE Connectivity checks happen between Alice and Bob in step 9. ICE Connectivity checks also happens between Alice and the B2BUA and Bob and the B2BUA as shown in step 10, 11. Step 9, 10, 11 happens in parallel. In this example Alice and Bob conclude ICE with a candidate pair that enables them to send media directly between them.</li>
  <li>Media flows between Alice and Bob in Step 12. </li>
</ol>
<h1 id="rfc.section.3.4"><a href="#rfc.section.3.4">3.4.</a> STUN Handling in B2BUA with Forked Signaling</h1>
<p id="rfc.section.3.4.p.1">Because of forking a B2BUA may receive multiple answers for a single outbound INVITE.  When this occurs the B2BUA should follow section 3.2 or 3.3 for all of those received answers.</p>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> Security Considerations</h1>
<p id="rfc.section.4.p.1">TBA</p>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#sec.iana-considerations" id="sec.iana-considerations">IANA Considerations</a></h1>
<p id="rfc.section.5.p.1">This document makes no request of IANA.</p>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> Acknowledgments</h1>
<p id="rfc.section.6.p.1">Special thanks to  Dan Wing,  Pal Martinsen, Charles Eckel, Marc Petit-Hueguenin, Simon Perreault and Lorenzo Miniero for their constructive comments, suggestions, and early reviews that were critical to the formulation and refinement of this document.</p>
<h1 id="rfc.references"><a href="#rfc.references">7.</a> References</h1>
<h1 id="rfc.references.1"><a href="#rfc.references.1">7.1.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="RFC2119">[RFC2119]</b>
      </td>
      <td class="top"><a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3424">[RFC3424]</b>
      </td>
      <td class="top"><a>Daigle, L.</a> and <a>IAB</a>, "<a href="http://tools.ietf.org/html/rfc3424">IAB Considerations for UNilateral Self-Address Fixing (UNSAF) Across Network Address Translation</a>", RFC 3424, November 2002.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3489">[RFC3489]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, <a>Weinberger, J.</a>, <a>Huitema, C.</a> and <a>R. Mahy</a>, "<a href="http://tools.ietf.org/html/rfc3489">STUN - Simple Traversal of User Datagram Protocol (UDP) Through Network Address Translators (NATs)</a>", RFC 3489, March 2003.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3711">[RFC3711]</b>
      </td>
      <td class="top"><a>Baugher, M.</a>, <a>McGrew, D.</a>, <a>Naslund, M.</a>, <a>Carrara, E.</a> and <a>K. Norrman</a>, "<a href="http://tools.ietf.org/html/rfc3711">The Secure Real-time Transport Protocol (SRTP)</a>", RFC 3711, March 2004.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4086">[RFC4086]</b>
      </td>
      <td class="top"><a>Eastlake, D.</a>, <a>Schiller, J.</a> and <a>S. Crocker</a>, "<a href="http://tools.ietf.org/html/rfc4086">Randomness Requirements for Security</a>", BCP 106, RFC 4086, June 2005.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5245">[RFC5245]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, "<a href="http://tools.ietf.org/html/rfc5245">Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal for Offer/Answer Protocols</a>", RFC 5245, April 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5389">[RFC5389]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, <a>Mahy, R.</a>, <a>Matthews, P.</a> and <a>D. Wing</a>, "<a href="http://tools.ietf.org/html/rfc5389">Session Traversal Utilities for NAT (STUN)</a>", RFC 5389, October 2008.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5763">[RFC5763]</b>
      </td>
      <td class="top"><a>Fischl, J.</a>, <a>Tschofenig, H.</a> and <a>E. Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5763">Framework for Establishing a Secure Real-time Transport Protocol (SRTP) Security Context Using Datagram Transport Layer Security (DTLS)</a>", RFC 5763, May 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5764">[RFC5764]</b>
      </td>
      <td class="top"><a>McGrew, D.</a> and <a>E. Rescorla</a>, "<a href="http://tools.ietf.org/html/rfc5764">Datagram Transport Layer Security (DTLS) Extension to Establish Keys for the Secure Real-time Transport Protocol (SRTP)</a>", RFC 5764, May 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5766">[RFC5766]</b>
      </td>
      <td class="top"><a>Mahy, R.</a>, <a>Matthews, P.</a> and <a>J. Rosenberg</a>, "<a href="http://tools.ietf.org/html/rfc5766">Traversal Using Relays around NAT (TURN): Relay Extensions to Session Traversal Utilities for NAT (STUN)</a>", RFC 5766, April 2010.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.references.2"><a href="#rfc.references.2">7.2.</a> Informative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="I-D.ietf-mmusic-latching">[I-D.ietf-mmusic-latching]</b>
      </td>
      <td class="top"><a>Ivov, E.</a>, <a>Kaplan, H.</a> and <a>D. Wing</a>, "<a href="http://tools.ietf.org/html/draft-ietf-mmusic-latching-08">Latching: Hosted NAT Traversal (HNT) for Media in Real-Time Communication</a>", Internet-Draft draft-ietf-mmusic-latching-08, June 2014.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.ram-straw-b2bua-dtls-srtp">[I-D.ram-straw-b2bua-dtls-srtp]</b>
      </td>
      <td class="top"><a>R, R.</a>, <a>Reddy, T.</a>, <a>Salgueiro, G.</a> and <a>V. Pascual</a>, "<a href="http://tools.ietf.org/html/draft-ram-straw-b2bua-dtls-srtp-00">DTLS-SRTP Handling in Session Initiation Protocol (SIP) Back-to-Back User Agents (B2BUAs)</a>", Internet-Draft draft-ram-straw-b2bua-dtls-srtp-00, June 2014.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3022">[RFC3022]</b>
      </td>
      <td class="top"><a>Srisuresh, P.</a> and <a>K. Egevang</a>, "<a href="http://tools.ietf.org/html/rfc3022">Traditional IP Network Address Translator (Traditional NAT)</a>", RFC 3022, January 2001.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3261">[RFC3261]</b>
      </td>
      <td class="top"><a>Rosenberg, J.</a>, <a>Schulzrinne, H.</a>, <a>Camarillo, G.</a>, <a>Johnston, A.</a>, <a>Peterson, J.</a>, <a>Sparks, R.</a>, <a>Handley, M.</a> and <a>E. Schooler</a>, "<a href="http://tools.ietf.org/html/rfc3261">SIP: Session Initiation Protocol</a>", RFC 3261, June 2002.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4566">[RFC4566]</b>
      </td>
      <td class="top"><a>Handley, M.</a>, <a>Jacobson, V.</a> and <a>C. Perkins</a>, "<a href="http://tools.ietf.org/html/rfc4566">SDP: Session Description Protocol</a>", RFC 4566, July 2006.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC6888">[RFC6888]</b>
      </td>
      <td class="top"><a>Perreault, S.</a>, <a>Yamagata, I.</a>, <a>Miyakawa, S.</a>, <a>Nakagawa, A.</a> and <a>H. Ashida</a>, "<a href="http://tools.ietf.org/html/rfc6888">Common Requirements for Carrier-Grade NATs (CGNs)</a>", BCP 127, RFC 6888, April 2013.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7092">[RFC7092]</b>
      </td>
      <td class="top"><a>Kaplan, H.</a> and <a>V. Pascual</a>, "<a href="http://tools.ietf.org/html/rfc7092">A Taxonomy of Session Initiation Protocol (SIP) Back-to-Back User Agents</a>", RFC 7092, December 2013.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Authors' Addresses</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Ram Mohan Ravindranath</span> 
	  <span class="n hidden">
		<span class="family-name">Ravindranath</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco</span>
	<span class="adr">
	  <span class="vcardline">Cessna Business Park</span>
<span class="vcardline">Sarjapur-Marathahalli Outer Ring Road</span>

	  <span class="vcardline">
		<span class="locality">Bangalore</span>,  
		<span class="region">Karnataka</span> 
		<span class="code">560103</span>
	  </span>
	  <span class="country-name vcardline">India</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:rmohanr@cisco.com">rmohanr@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Tirumaleswar Reddy</span> 
	  <span class="n hidden">
		<span class="family-name">Reddy</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco</span>
	<span class="adr">
	  <span class="vcardline">Cessna Business Park, Varthur Hobli</span>
<span class="vcardline">Sarjapur Marathalli Outer Ring Road</span>

	  <span class="vcardline">
		<span class="locality">Bangalore</span>,  
		<span class="region">Karnataka</span> 
		<span class="code">560103</span>
	  </span>
	  <span class="country-name vcardline">India</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:tireddy@cisco.com">tireddy@cisco.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Gonzalo Salgueiro</span> 
	  <span class="n hidden">
		<span class="family-name">Salgueiro</span>
	  </span>
	</span>
	<span class="org vcardline">Cisco Systems, Inc.</span>
	<span class="adr">
	  <span class="vcardline">7200-12 Kit Creek Road</span>

	  <span class="vcardline">
		<span class="locality">Research Triangle Park</span>,  
		<span class="region">NC</span> 
		<span class="code">27709</span>
	  </span>
	  <span class="country-name vcardline">US</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:gsalguei@cisco.com">gsalguei@cisco.com</a></span>

  </address>
</div>

</body>
</html>
